{"version":3,"sources":["src/js/rldemo.js"],"names":["canvas","ctx","Food","constructor","pos","rad","_view","THREE","Mesh","SphereBufferGeometry","MeshBasicMaterial","color","age","type","cleanup_","_rl","position","copy","view","vec","Poison","Agent","BoxBufferGeometry","actions","push","eyes","r","alpha","i","eye","Eye","mesh","add","_frontEye","length","Math","round","brain","Brain","reward_bonus","digestion_signal","rot1","rot2","prevactionix","forward","num_eyes","input_array","Array","e","sensed_type","sensed_proximity","max_range","actionix","action","backward","proximity_reward","min","forward_reward","digestion_reward","reward","angle","rotation","z","val","frontEye","a","x","sin","PI","y","cos","geometry","computeBoundingBox","raycaster","Raycaster","getNearestCollision","targets_objs","targets","map","el","dst","Vector3","setFromMatrixPosition","matrixWorld","clone","negate","normalize","set","intersects","intersectObjects","distance","obj","object","dist","Wall","p1","p2","CubeBufferGeometry","boundingBox","Item","Object3D","World","init","agents","W","H","clock","walls","pad","items","k","generateItem","agent","Scene","convnetjs","randf","t","randi","it","json_params","Container","document","createElement","id","classList","Renderer","WebGLRenderer","setSize","window","innerWidth","innerHeight","appendChild","domElement","body","insertBefore","firstChild","stats","Stats","dom","Camera","PerspectiveCamera","background","Color","fog","FogExp2","Loader","ColladaLoader","AmbientLight","Controls","FlyControls","getElementById","movementSpeed","rollSpeed","autoForward","dragToLook","Clock","TextureLoader","load","tex","wrapS","RepeatWrapping","wrapT","repeat","ground","PlaneBufferGeometry","side","DoubleSide","bind","render","update","delta","getDelta","w","visSelf","stuff_collide_","check_walls","check_items","minres","res","removeItem","remove","splice","indexOf","tick","collpoints","n","ei","ne","op","oangle","v","rotat","Matrix4","makeRotationZ","applyMatrix4","w1p","w2p","sub","vv","vv2","np","multiplyScalar","np2","update_items","j","m","d","distanceTo","rescheck","draw_net","simspeed","getContext","width","height","clearRect","L","value_net","layers","dx","font","fillStyle","fillText","out_act","kw","dy","layer_type","q","floor","fillRect","reward_graph","cnnvis","Graph","draw_stats","b","netin","last_input_array","strokeStyle","lineWidth","beginPath","moveTo","lineTo","stroke","average_reward_window","get_average","gcanvas","drawSelf","skipdraw","goveryfast","clearInterval","current_interval_id","setInterval","gofast","gonormal","goslow","savenet","toJSON","JSON","stringify","value","loadnet","parse","fromJSON","stoplearn","startlearn","learning","reload","start"],"mappings":"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","file":"rldemo.map","sourceRoot":"..","sourcesContent":[" var canvas, ctx;\r\n    \r\n  class Food {\r\n    constructor(pos){\r\n      this.rad = 1;\r\n      this._view = new THREE.Mesh(\r\n        new THREE.SphereBufferGeometry(this.rad,this.rad,this.rad),\r\n        new THREE.MeshBasicMaterial({color: 0x11FF11})\r\n      )\r\n      this.age = 0;\r\n      this.type = 1;\r\n      this.cleanup_ = false;\r\n      this._view._rl = {\r\n        type: this.type\r\n      }\r\n      this._view.position.copy(pos);\r\n    }\r\n    get view(){\r\n      return this._view;\r\n    }\r\n    get position(){\r\n      return this._view.position;\r\n    }\r\n    set position(vec){\r\n      this._view.position.copy(vec);\r\n    }\r\n  }\r\n\r\n  class Poison {\r\n    constructor(pos){\r\n      this.rad = 1;\r\n      this._view = new THREE.Mesh(\r\n        new THREE.SphereBufferGeometry(this.rad,this.rad,this.rad),\r\n        new THREE.MeshBasicMaterial({color: 0xFFF422})\r\n      )      \r\n      this.age = 0;\r\n      this.type = 2;\r\n      this.cleanup_ = false;\r\n      this._view.position.copy(pos);\r\n      this._view._rl = {\r\n        type: this.type\r\n      }\r\n    }\r\n    get view(){\r\n      return this._view;\r\n    }\r\n    get position(){\r\n      return this._view.position;\r\n    }\r\n    set position(vec){\r\n      this._view.position.copy(vec);\r\n    }\r\n  }\r\n\r\n  class Agent{\r\n    constructor(){\r\n      this.rad = 2;\r\n      this._view = new THREE.Mesh(\r\n        new THREE.BoxBufferGeometry(this.rad,this.rad,this.rad),\r\n        new THREE.MeshBasicMaterial({color: 0xFFAA11})\r\n      );\r\n      \r\n      this.actions = [];\r\n      this.actions.push([1,1]);\r\n      this.actions.push([0.8,1]);\r\n      this.actions.push([1,\r\n        0.8]);\r\n      this.actions.push([0.5,0]);\r\n      this.actions.push([0,0.5]);\r\n      \r\n      // properties\r\n      this.eyes = [];\r\n      /**star */\r\n      let r = 20;\r\n      let alpha = 0;\r\n      /**Now we create agent's eyes*/\r\n      for (let i = 0; i < 10; i++){\r\n          let eye = new Eye(this, alpha, r);\r\n          let mesh = eye.view;\r\n          this.view.add(mesh);\r\n          this.eyes.push(eye);\r\n          alpha += r;\r\n      }\r\n      this._frontEye = null;\r\n      if(this.eyes.length % 2 === 0){\r\n        this._frontEye = this.eyes[Math.round(this.eyes.length/2)];\r\n      }else {\r\n        this._frontEye = this.eyes[Math.round(this.eyes.length/2)-1];\r\n      }\r\n      // braaain\r\n      this.brain = new Brain(this.eyes.length * 3, this.actions.length);\r\n      //var spec = document.getElementById('qspec').value;\r\n      //eval(spec);\r\n      //this.brain = brain;\r\n      \r\n      this.reward_bonus = 0.0;\r\n      this.digestion_signal = 0.0;\r\n      // outputs on world\r\n      this.rot1 = 0.0; // rotation speed of 1st wheel\r\n      this.rot2 = 0.0; // rotation speed of 2nd wheel\r\n      \r\n      this.prevactionix = -1;\r\n\r\n    }\r\n    \r\n\r\n    forward() {\r\n      // in forward pass the agent simply behaves in the environment\r\n      // create input to brain\r\n      var num_eyes = this.eyes.length;\r\n      var input_array = new Array(num_eyes * 3);\r\n      for(var i=0;i<num_eyes;i++) {\r\n        var e = this.eyes[i];\r\n        input_array[i*3] = 1.0;\r\n        input_array[i*3+1] = 1.0;\r\n        input_array[i*3+2] = 1.0;\r\n        if(e.sensed_type !== -1) {\r\n          // sensed_type is 0 for wall, 1 for food and 2 for poison.\r\n          // lets do a 1-of-k encoding into the input array\r\n          input_array[i*3 + e.sensed_type] = e.sensed_proximity/e.max_range; // normalize to [0,1]\r\n        }\r\n      }\r\n      \r\n      // get action from brain\r\n      var actionix = this.brain.forward(input_array);\r\n      var action = this.actions[actionix];\r\n      this.actionix = actionix; //back this up\r\n      \r\n      // demultiplex into behavior variables\r\n      this.rot1 = action[0]*1;\r\n      this.rot2 = action[1]*1;\r\n      \r\n      //this.rot1 = 0;\r\n      //this.rot2 = 0;\r\n    }\r\n\r\n    backward() {\r\n      // in backward pass agent learns.\r\n      // compute reward \r\n      var proximity_reward = 0.0;\r\n      var num_eyes = this.eyes.length;\r\n      for(var i=0;i<num_eyes;i++) {\r\n        var e = this.eyes[i];\r\n        // agents dont like to see walls, especially up close\r\n        proximity_reward += e.sensed_type === 0 ? e.sensed_proximity/e.max_range : 1.0;\r\n      }\r\n      proximity_reward = proximity_reward/num_eyes;\r\n      proximity_reward = Math.min(1.0, proximity_reward * 2);\r\n      \r\n      // agents like to go straight forward\r\n      var forward_reward = 0.0;\r\n      if(this.actionix === 0 && proximity_reward > 0.75) forward_reward = 0.1 * proximity_reward;\r\n      \r\n      // agents like to eat good things\r\n      var digestion_reward = this.digestion_signal;\r\n      this.digestion_signal = 0.0;\r\n      \r\n      var reward = proximity_reward + forward_reward + digestion_reward;\r\n      \r\n      // pass to brain for learning\r\n      this.brain.backward(reward);\r\n    }\r\n\r\n    get view(){\r\n      return this._view;\r\n    }\r\n    get position(){\r\n      return this._view.position;\r\n    }\r\n    set position(vec){\r\n      this._view.position.copy(vec);\r\n    }\r\n    get angle(){\r\n      return this._view.rotation.z;\r\n    }\r\n    set angle(val){\r\n      this._view.rotation.z = val;\r\n    }\r\n    get frontEye(){\r\n      return this._frontEye;\r\n    }\r\n  }\r\n  /**\r\n   * @class Eye\r\n   * It presents as agent's eye detector.\r\n   */\r\n  class Eye{\r\n    /**\r\n     * \r\n     * @param {THREE.Vector3} agent_pos_vec Vector that would use as src\r\n     * vector for raycastring\r\n     * @param {Number} alpha angle \r\n     * @param {Number} r radius\r\n     */\r\n    constructor(a, alpha, r){\r\n      this._view = new THREE.Mesh(\r\n        new THREE.BoxBufferGeometry(1,1,10),\r\n        new THREE.MeshBasicMaterial({color: 0x111111})\r\n      );\r\n      /**setting Eye position and rotation */\r\n      this._view.position.x = Math.sin(Math.PI*alpha/180)*r;\r\n      this._view.position.y = Math.cos(Math.PI*alpha/180)*r;\r\n      this._view.rotation.z = Math.PI*(180-alpha)/180;\r\n      this._view.geometry.computeBoundingBox();\r\n      this.raycaster = new THREE.Raycaster();\r\n      this.max_range = 20;\r\n      this.sensed_proximity = 20; // what the eye is seeing. will be set in world.tick()\r\n      this.a = a;\r\n    }\r\n    get view(){\r\n      return this._view;\r\n    }\r\n    /**\r\n     * This function return the nearest detected object.\r\n     * @param {THREE.Mesh[]} targets array of intersection targets\r\n     * @returns {Object|null} \r\n     */\r\n    getNearestCollision(targets_objs){\r\n      let targets = targets_objs.map((el)=>{\r\n          return el.view;\r\n      });\r\n      let dst = new THREE.Vector3();\r\n      dst.setFromMatrixPosition( this._view.matrixWorld );\r\n      dst.add(this.a.position.clone().negate());\r\n      dst.normalize();\r\n      this.raycaster.set(this.a.position, dst);\r\n      let intersects = this.raycaster.intersectObjects(targets);\r\n      if (intersects.length > 0 && intersects[0].distance < this.max_range){\r\n        return {obj: intersects[0].object, type: intersects[0].object._rl.type, dist: intersects[0].distance}\r\n      } else {\r\n        return null;\r\n      }\r\n    }\r\n  }\r\n    \r\n    class Wall {\r\n      constructor(p1, p2){\r\n        this._view = new THREE.Mesh(\r\n          new THREE.CubeBufferGeometry(),\r\n          new THREE.MeshBasicMaterial({color: 0xf2f2f2})\r\n        );\r\n        this.type = 0;\r\n      }\r\n      get boundingBox(){\r\n        this._view.geometry.computeBoundingBox();\r\n        return this._view.geometry.boundingBox;\r\n      }\r\n    }\r\n    \r\n    \r\n    var Item = THREE.Object3D;\r\n    /**\r\n     * @class\r\n     * World Contains all features.\r\n     */\r\n    class World  {\r\n      constructor(){\r\n        this.init();\r\n        this.agents = [];\r\n        // this.W = canvas.width;\r\n        // this.H = canvas.height;\r\n\r\n        this.W = 300;\r\n        this.H = 300;\r\n\r\n        this.clock = 0;\r\n        \r\n        // set up walls in the world\r\n        this.walls = []; \r\n        var pad = 10;\r\n        // util_add_box(this.walls, pad, pad, this.W-pad*2, this.H-pad*2);\r\n        // util_add_box(this.walls, 100, 100, 200, 300); // inner walls\r\n        // this.walls.pop();\r\n        // util_add_box(this.walls, 400, 100, 200, 300);\r\n        // this.walls.pop();\r\n        \r\n\r\n        // set up food and poison\r\n        this.items = []\r\n        for(var k=0;k<4000;k++) {\r\n          this.generateItem();\r\n        }\r\n        let agent = new Agent();\r\n        this.Scene.add(agent.view);\r\n        this.agents.push(agent);\r\n      }   \r\n\r\n      generateItem(){\r\n        var x = convnetjs.randf(-150, this.W-100);\r\n        var y = convnetjs.randf(-150, this.H-100);\r\n        var t = convnetjs.randi(1, 3); // food or poison (1 and 2)\r\n        if (t == 1){\r\n          var it = new Food(new THREE.Vector3(x, y, 0));\r\n        }\r\n        else{\r\n          var it = new Poison(new THREE.Vector3(x, y, 0));\r\n        }\r\n        this.items.push(it);\r\n        this.Scene.add(it.view);\r\n      }\r\n\r\n      init(json_params){\r\n        this.Container = document.createElement(\"div\");\r\n        this.Container.id = \"MainContainer\";\r\n        this.Container.classList.add(\"Container\");\r\n        \r\n        this.Renderer = new THREE.WebGLRenderer();\r\n        this.Renderer.setSize(window.innerWidth, window.innerHeight);\r\n        this.Container.appendChild(this.Renderer.domElement);\r\n\r\n        document.body.insertBefore( this.Container, document.body.firstChild);\r\n\r\n        this.stats = new Stats();\r\n        document.body.appendChild(this.stats.dom);\r\n\r\n        this.Camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 10000);\r\n        this.Camera.position.set(0,0, 10);\r\n        this.Scene = new THREE.Scene();\r\n        this.Scene.background = new THREE.Color( 0xaaccff );\r\n        this.Scene.fog = new THREE.FogExp2( 0xaaccff, 0.007 );\r\n        //        this.Scene.add(this.Camera);\r\n\r\n        this.Loader = new THREE.ColladaLoader();\r\n//        this.Loader.load(\"./src/scenes/telefermer.dae\", function (dae) {\r\n//            dae.scene.scale.set(10,10,10);\r\n//            this.Scene.add(dae.scene);\r\n//        }.bind(this));\r\n\r\n        this.AmbientLight = new THREE.AmbientLight(0xFFFFFF, 0.9);\r\n        this.Scene.add(this.AmbientLight);\r\n\r\n        // this.ControlObject = this.Object;\r\n        // // this.Camera.position.set(-1, 1.2, -0.35);\r\n        // this.Scene.add(this.ControlObject);\r\n        // this.ControlObject.add(this.Camera);\r\n        this.Controls = new THREE.FlyControls(this.Camera, document.getElementById(\"MainContainer\"));\r\n        this.Controls.movementSpeed = 13;\r\n        this.Controls.rollSpeed = Math.PI / 8;\r\n        this.Controls.autoForward = false;\r\n        this.Controls.dragToLook = false;\r\n        \r\n        this.Clock = new THREE.Clock();\r\n\r\n        let TextureLoader = new THREE.TextureLoader();\r\n        TextureLoader.load(\"./src/models/forest/grass.png\", function (tex) {\r\n            tex.wrapS = THREE.RepeatWrapping;\r\n            tex.wrapT = THREE.RepeatWrapping;\r\n            tex.repeat.set(100, 100);\r\n            let ground = new THREE.Mesh(new THREE.PlaneBufferGeometry(1000, 1000), new THREE.MeshBasicMaterial({map: tex, side:THREE.DoubleSide}));\r\n            //ground.rotation.x -= Math.PI/2;\r\n            this.Scene.add(ground);\r\n        }.bind(this));\r\n      }\r\n\r\n      render () {\r\n        //requestAnimationFrame(this.render);\r\n        this.stats.update();\r\n        // this.ControlObject.position.y = 0;\r\n        \r\n        this.Renderer.render(this.Scene, this.Camera);\r\n        var delta = this.Clock.getDelta();\r\n        // if(this.Controls.moveState.forward || this.Controls.moveState.back){\r\n        //     if (this.Mixer !== undefined ) {\r\n        //         this.Mixer.update(delta);\r\n        //     }\r\n        // }\r\n        // if (this.Mixer !== undefined ) {\r\n        //         this.Mixer.update(delta);\r\n        //     }\r\n        \r\n         w.agents[0].brain.visSelf(document.getElementById('brain_info_div'));\r\n        this.Controls.update(delta);\r\n    }\r\n\r\n      // helper function to get closest colliding walls/items\r\n      stuff_collide_(eye, check_walls, check_items) {\r\n        var minres = false;\r\n\r\n        if(check_walls) {\r\n            let res = eye.getNearestCollision(this.walls);\r\n            if(res) {\r\n              res.type = 0; // 0 is wall\r\n              if(!minres) { minres=res; }\r\n            }\r\n        }\r\n        // collide with items\r\n        if(check_items) {\r\n          let res = eye.getNearestCollision(this.items);\r\n          if(res) {\r\n            if(!minres) { minres=res; }\r\n          }\r\n        }\r\n        return minres;\r\n      }\r\n      removeItem(it){\r\n        this.Scene.remove(it.view);\r\n        this.items.splice(this.items.indexOf(it), 1);\r\n      }\r\n      tick() {\r\n        // tick the environment\r\n        this.clock++;\r\n        \r\n        // fix input to all agents based on environment\r\n        // process eyes\r\n        this.collpoints = [];\r\n        for(var i=0,n=this.agents.length;i<n;i++) {\r\n          var a = this.agents[i];\r\n          for(var ei=0,ne=a.eyes.length;ei<ne;ei++) {\r\n            var e = a.eyes[ei];\r\n            // we have a line from p to p->eyep\r\n            var res = this.stuff_collide_(e, true, true);\r\n            if(res) {\r\n              // eye collided with wall\r\n              e.sensed_proximity = res.dist;\r\n              e.sensed_type = res.type;\r\n            } else {\r\n              e.sensed_proximity = e.max_range;\r\n              e.sensed_type = -1;\r\n            }\r\n          }\r\n        }\r\n        \r\n        // let the agents behave in the world based on their input\r\n        for(var i=0,n=this.agents.length;i<n;i++) {\r\n          this.agents[i].forward();\r\n        }\r\n        \r\n        // apply outputs of agents on evironment\r\n        for(var i=0,n=this.agents.length;i<n;i++) {\r\n          var a = this.agents[i];\r\n          a.op = a.position.clone(); // back up old position\r\n          a.oangle = a.angle; // and angle\r\n          // steer the agent according to outputs of wheel velocities\r\n          var v = new THREE.Vector3(0, a.rad / 2.0);\r\n          var rotat = new THREE.Matrix4().makeRotationZ(a.angle + Math.PI/2);\r\n          v = v.applyMatrix4(rotat);\r\n          var w1p = a.position.clone().add(v); // positions of wheel 1 and 2\r\n          var w2p =a.position.clone().sub(v);\r\n          var vv = a.position.clone().sub(w2p);\r\n          rotat = new THREE.Matrix4().makeRotationZ(-a.rot1);\r\n          vv = vv.applyMatrix4(rotat);\r\n          var vv2 = a.position.clone().sub(w1p);\r\n          rotat = new THREE.Matrix4().makeRotationZ(a.rot2);\r\n          vv2 = vv2.clone().applyMatrix4(rotat);\r\n          var np = w2p.clone().add(vv);\r\n          np.multiplyScalar(0.5);\r\n          var np2 = w1p.clone().add(vv2);\r\n          np2.multiplyScalar(0.5);\r\n          a.position = np.add(np2);\r\n          \r\n          a.angle -= a.rot1;\r\n          if(a.angle<0)a.angle+=2*Math.PI;\r\n          a.angle += a.rot2;\r\n          if(a.angle>2*Math.PI)a.angle-=2*Math.PI;\r\n          \r\n          // agent is trying to move from p to op. Check walls\r\n          var res = this.stuff_collide_(a.frontEye, true, false);\r\n          if(res) {\r\n            // wall collision! reset position\r\n            a.position = a.op;\r\n          }\r\n          \r\n          // handle boundary conditions\r\n          if(a.position.x<0)a.position.x=0;\r\n          if(a.position.x>this.W)a.position.x=this.W;\r\n          if(a.position.y<0)a.position.y=0;\r\n          if(a.position.y>this.H)a.position.y=this.H;\r\n        }\r\n        \r\n        // tick all items\r\n        var update_items = false;\r\n        for(var i=0,n=this.items.length;i<n;i++) {\r\n          var it = this.items[i];\r\n          it.age += 1;\r\n          \r\n          // see if some agent gets lunch\r\n          for(var j=0,m=this.agents.length;j<m;j++) {\r\n            var a = this.agents[j];\r\n            var d = a.position.distanceTo(it.position);\r\n            if(d < it.rad + a.rad) {\r\n              \r\n              // wait lets just make sure that this isn't through a wall\r\n              var rescheck = this.stuff_collide_(a.frontEye, true, false);\r\n              if(!rescheck) { \r\n                // ding! nom nom nom\r\n                if(it.type === 1) a.digestion_signal += 5.0; // mmm delicious apple\r\n                if(it.type === 2) a.digestion_signal += -6.0; // ewww poison\r\n                this.removeItem(it);\r\n                i--;\r\n                n--;\r\n                break; // break out of loop, item was consumed\r\n              }\r\n            }\r\n          }\r\n          \r\n          if(it.age > 5000 && this.clock % 100 === 0 && convnetjs.randf(0,1)<0.1) {\r\n            this.removeItem(it);\r\n            i--;\r\n            n--;\r\n          }\r\n        }\r\n        if(this.items.length < 5000) {\r\n          this.generateItem();\r\n        }\r\n        \r\n        // agents are given the opportunity to learn based on feedback of their action on environment\r\n        for(var i=0,n=this.agents.length;i<n;i++) {\r\n          this.agents[i].backward();\r\n        }\r\n      }\r\n    }\r\n    \r\n    \r\n    function draw_net() {\r\n      if(simspeed <=1) {\r\n        // we will always draw at these speeds\r\n      } else {\r\n        if(w.clock % 50 !== 0) return;  // do this sparingly\r\n      }\r\n      \r\n      var canvas = document.getElementById(\"net_canvas\");\r\n      var ctx = canvas.getContext(\"2d\");\r\n      var W = canvas.width;\r\n      var H = canvas.height;\r\n      ctx.clearRect(0, 0, canvas.width, canvas.height);\r\n      var L = w.agents[0].brain.value_net.layers;\r\n      var dx = (W - 50)/L.length;\r\n      var x = 10;\r\n      var y = 40;\r\n      ctx.font=\"12px Verdana\";\r\n      ctx.fillStyle = \"rgb(0,0,0)\";\r\n      ctx.fillText(\"Value Function Approximating Neural Network:\", 10, 14);\r\n      for(var k=0;k<L.length;k++) {\r\n        if(typeof(L[k].out_act)==='undefined') continue; // maybe not yet ready\r\n        var kw = L[k].out_act.w;\r\n        var n = kw.length;\r\n        var dy = (H-50)/n;\r\n        ctx.fillStyle = \"rgb(0,0,0)\";\r\n        ctx.fillText(L[k].layer_type + \"(\" + n + \")\", x, 35);\r\n        for(var q=0;q<n;q++) {\r\n          var v = Math.floor(kw[q]*100);\r\n          if(v >= 0) ctx.fillStyle = \"rgb(0,0,\" + v + \")\";\r\n          if(v < 0) ctx.fillStyle = \"rgb(\" + (-v) + \",0,0)\";\r\n          ctx.fillRect(x,y,10,10);\r\n          y += 12;\r\n          if(y>H-25) { y = 40; x += 12};\r\n        }\r\n        x += 50;\r\n        y = 40;\r\n      }\r\n    }\r\n    \r\n    var reward_graph = new cnnvis.Graph();\r\n    function draw_stats() {\r\n      var canvas = document.getElementById(\"vis_canvas\");\r\n      var ctx = canvas.getContext(\"2d\");\r\n      var W = canvas.width;\r\n      var H = canvas.height;\r\n      ctx.clearRect(0, 0, canvas.width, canvas.height);\r\n      var a = w.agents[0];\r\n      var b = a.brain;\r\n      var netin = b.last_input_array;\r\n      ctx.strokeStyle = \"rgb(0,0,0)\";\r\n      //ctx.font=\"12px Verdana\";\r\n      //ctx.fillText(\"Current state:\",10,10);\r\n      ctx.lineWidth = 10;\r\n      ctx.beginPath();\r\n      for(var k=0,n=netin.length;k<n;k++) {\r\n        ctx.moveTo(10+k*12, 120);\r\n        ctx.lineTo(10+k*12, 120 - netin[k] * 100);\r\n      }\r\n      ctx.stroke();\r\n      \r\n      if(w.clock % 200 === 0) {\r\n        reward_graph.add(w.clock/200, b.average_reward_window.get_average());\r\n        var gcanvas = document.getElementById(\"graph_canvas\");\r\n        reward_graph.drawSelf(gcanvas);\r\n      }\r\n    }\r\n\r\n    // Tick the world\r\n    function tick() {\r\n      w.tick();\r\n      if(!skipdraw || w.clock % 50 === 0) {\r\n        w.render();\r\n        draw_stats();\r\n        //draw_net();\r\n      }\r\n    }\r\n    \r\n    var simspeed = 2;\r\n    function goveryfast() {\r\n      window.clearInterval(current_interval_id);\r\n      current_interval_id = setInterval(tick, 0);\r\n      skipdraw = true;\r\n      simspeed = 3;\r\n    }\r\n    function gofast() {\r\n      window.clearInterval(current_interval_id);\r\n      current_interval_id = setInterval(tick, 0);\r\n      skipdraw = false;\r\n      simspeed = 2;\r\n    }\r\n    function gonormal() {\r\n      window.clearInterval(current_interval_id);\r\n      current_interval_id = setInterval(tick, 30);\r\n      skipdraw = false;\r\n      simspeed = 1;\r\n    }\r\n    function goslow() {\r\n      window.clearInterval(current_interval_id);\r\n      current_interval_id = setInterval(tick, 200);\r\n      skipdraw = false;\r\n      simspeed = 0;\r\n    }\r\n    \r\n    function savenet() {\r\n      var j = w.agents[0].brain.value_net.toJSON();\r\n      var t = JSON.stringify(j);\r\n      document.getElementById('tt').value = t;\r\n    }\r\n    \r\n    function loadnet() {\r\n      var t = document.getElementById('tt').value;\r\n      var j = JSON.parse(t);\r\n      w.agents[0].brain.value_net.fromJSON(j);\r\n      stoplearn(); // also stop learning\r\n      gonormal();\r\n    }\r\n    \r\n    function startlearn() {\r\n      w.agents[0].brain.learning = true;\r\n    }\r\n    function stoplearn() {\r\n      w.agents[0].brain.learning = false;\r\n    }\r\n    \r\n    function reload() {\r\n      w.agents = [new Agent()]; // this should simply work. I think... ;\\\r\n      reward_graph = new cnnvis.Graph(); // reinit\r\n    }\r\n    \r\n    var w; // global world object\r\n    var current_interval_id;\r\n    var skipdraw = false;\r\n\r\n    function start() {\r\n      canvas = document.getElementById(\"canvas\");\r\n      ctx = canvas.getContext(\"2d\");\r\n      \r\n      w = new World();\r\n      \r\n      gofast();\r\n    }"]}