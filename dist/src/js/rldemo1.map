{"version":3,"sources":["src/js/rldemo1.js"],"names":["canvas","ctx","Food","constructor","pos","rad","_view","THREE","Mesh","SphereBufferGeometry","MeshBasicMaterial","color","age","type","cleanup_","_rl","position","copy","view","vec","Poison","Agent","BoxBufferGeometry","actions","push","eyes","r","alpha","i","eye","Eye","mesh","add","_frontEye","length","Math","round","brain","deepqlearn","Brain","spec","document","getElementById","value","eval","reward_bonus","digestion_signal","rot1","rot2","prevactionix","forward","num_eyes","input_array","Array","e","sensed_type","sensed_proximity","max_range","actionix","action","backward","proximity_reward","min","forward_reward","digestion_reward","reward","angle","rotation","z","val","frontEye","a","x","sin","PI","y","cos","geometry","computeBoundingBox","raycaster","Raycaster","getNearestCollision","targets_objs","targets","map","el","dst","Vector3","setFromMatrixPosition","matrixWorld","clone","negate","normalize","set","intersects","intersectObjects","distance","obj","object","dist","Wall","p1","p2","CubeBufferGeometry","boundingBox","Item","Object3D","World","init","agents","W","H","clock","walls","pad","items","k","generateItem","agent","Scene","convnetjs","randf","t","randi","it","json_params","Container","createElement","id","classList","Renderer","WebGLRenderer","setSize","window","innerWidth","innerHeight","appendChild","domElement","body","insertBefore","firstChild","stats","Stats","dom","Camera","PerspectiveCamera","background","Color","fog","FogExp2","Loader","ColladaLoader","AmbientLight","Controls","FlyControls","movementSpeed","rollSpeed","autoForward","dragToLook","Clock","TextureLoader","load","tex","wrapS","RepeatWrapping","wrapT","repeat","ground","PlaneBufferGeometry","side","DoubleSide","bind","render","update","delta","getDelta","w","visSelf","stuff_collide_","check_walls","check_items","minres","res","removeItem","remove","splice","indexOf","tick","collpoints","n","ei","ne","op","oangle","v","rotat","Matrix4","makeRotationZ","applyMatrix4","w1p","w2p","sub","vv","vv2","np","multiplyScalar","np2","update_items","j","m","d","distanceTo","rescheck","draw_net","simspeed","getContext","width","height","clearRect","L","value_net","layers","dx","font","fillStyle","fillText","out_act","kw","dy","layer_type","q","floor","fillRect","reward_graph","cnnvis","Graph","draw_stats","b","netin","last_input_array","strokeStyle","lineWidth","beginPath","moveTo","lineTo","stroke","average_reward_window","get_average","gcanvas","drawSelf","skipdraw","goveryfast","clearInterval","current_interval_id","setInterval","gofast","gonormal","goslow","savenet","toJSON","JSON","stringify","loadnet","parse","fromJSON","stoplearn","startlearn","learning","reload","start"],"mappings":"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","file":"rldemo1.map","sourceRoot":"..","sourcesContent":["var canvas, ctx;\r\n    \r\nclass Food {\r\n  constructor(pos){\r\n    this.rad = 1;\r\n    this._view = new THREE.Mesh(\r\n      new THREE.SphereBufferGeometry(this.rad,this.rad,this.rad),\r\n      new THREE.MeshBasicMaterial({color: 0x11FF11})\r\n    )\r\n    this.age = 0;\r\n    this.type = 1;\r\n    this.cleanup_ = false;\r\n    this._view._rl = {\r\n      type: this.type\r\n    }\r\n    this._view.position.copy(pos);\r\n  }\r\n  get view(){\r\n    return this._view;\r\n  }\r\n  get position(){\r\n    return this._view.position;\r\n  }\r\n  set position(vec){\r\n    this._view.position.copy(vec);\r\n  }\r\n}\r\n\r\nclass Poison {\r\n  constructor(pos){\r\n    this.rad = 1;\r\n    this._view = new THREE.Mesh(\r\n      new THREE.SphereBufferGeometry(this.rad,this.rad,this.rad),\r\n      new THREE.MeshBasicMaterial({color: 0xFFF422})\r\n    )      \r\n    this.age = 0;\r\n    this.type = 2;\r\n    this.cleanup_ = false;\r\n    this._view.position.copy(pos);\r\n    this._view._rl = {\r\n      type: this.type\r\n    }\r\n  }\r\n  get view(){\r\n    return this._view;\r\n  }\r\n  get position(){\r\n    return this._view.position;\r\n  }\r\n  set position(vec){\r\n    this._view.position.copy(vec);\r\n  }\r\n}\r\n\r\nclass Agent{\r\n  constructor(){\r\n    this.rad = 2;\r\n    this._view = new THREE.Mesh(\r\n      new THREE.BoxBufferGeometry(this.rad,this.rad,this.rad),\r\n      new THREE.MeshBasicMaterial({color: 0xFFAA11})\r\n    );\r\n    \r\n    this.actions = [];\r\n    this.actions.push([1,1]);\r\n    this.actions.push([0.8,1]);\r\n    this.actions.push([1,\r\n      0.8]);\r\n    this.actions.push([0.5,0]);\r\n    this.actions.push([0,0.5]);\r\n    \r\n    // properties\r\n    this.eyes = [];\r\n    /**star */\r\n    let r = 20;\r\n    let alpha = 0;\r\n    /**Now we create agent's eyes*/\r\n    for (let i = 0; i < 10; i++){\r\n        let eye = new Eye(this, alpha, r);\r\n        let mesh = eye.view;\r\n        this.view.add(mesh);\r\n        this.eyes.push(eye);\r\n        alpha += r;\r\n    }\r\n    this._frontEye = null;\r\n    if(this.eyes.length % 2 === 0){\r\n      this._frontEye = this.eyes[Math.round(this.eyes.length/2)];\r\n    }else {\r\n      this._frontEye = this.eyes[Math.round(this.eyes.length/2)-1];\r\n    }\r\n    // braaain\r\n    this.brain = new deepqlearn.Brain(this.eyes.length * 3, this.actions.length);\r\n    var spec = document.getElementById('qspec').value;\r\n    eval(spec);\r\n    //this.brain = brain;\r\n    \r\n    this.reward_bonus = 0.0;\r\n    this.digestion_signal = 0.0;\r\n    // outputs on world\r\n    this.rot1 = 0.0; // rotation speed of 1st wheel\r\n    this.rot2 = 0.0; // rotation speed of 2nd wheel\r\n    \r\n    this.prevactionix = -1;\r\n\r\n  }\r\n  \r\n\r\n  forward() {\r\n    // in forward pass the agent simply behaves in the environment\r\n    // create input to brain\r\n    var num_eyes = this.eyes.length;\r\n    var input_array = new Array(num_eyes * 3);\r\n    for(var i=0;i<num_eyes;i++) {\r\n      var e = this.eyes[i];\r\n      input_array[i*3] = 1.0;\r\n      input_array[i*3+1] = 1.0;\r\n      input_array[i*3+2] = 1.0;\r\n      if(e.sensed_type !== -1) {\r\n        // sensed_type is 0 for wall, 1 for food and 2 for poison.\r\n        // lets do a 1-of-k encoding into the input array\r\n        input_array[i*3 + e.sensed_type] = e.sensed_proximity/e.max_range; // normalize to [0,1]\r\n      }\r\n    }\r\n    \r\n    // get action from brain\r\n    var actionix = this.brain.forward(input_array);\r\n    var action = this.actions[actionix];\r\n    this.actionix = actionix; //back this up\r\n    \r\n    // demultiplex into behavior variables\r\n    this.rot1 = action[0]*1;\r\n    this.rot2 = action[1]*1;\r\n    \r\n    //this.rot1 = 0;\r\n    //this.rot2 = 0;\r\n  }\r\n\r\n  backward() {\r\n    // in backward pass agent learns.\r\n    // compute reward \r\n    var proximity_reward = 0.0;\r\n    var num_eyes = this.eyes.length;\r\n    for(var i=0;i<num_eyes;i++) {\r\n      var e = this.eyes[i];\r\n      // agents dont like to see walls, especially up close\r\n      proximity_reward += e.sensed_type === 0 ? e.sensed_proximity/e.max_range : 1.0;\r\n    }\r\n    proximity_reward = proximity_reward/num_eyes;\r\n    proximity_reward = Math.min(1.0, proximity_reward * 2);\r\n    \r\n    // agents like to go straight forward\r\n    var forward_reward = 0.0;\r\n    if(this.actionix === 0 && proximity_reward > 0.75) forward_reward = 0.1 * proximity_reward;\r\n    \r\n    // agents like to eat good things\r\n    var digestion_reward = this.digestion_signal;\r\n    this.digestion_signal = 0.0;\r\n    \r\n    var reward = proximity_reward + forward_reward + digestion_reward;\r\n    \r\n    // pass to brain for learning\r\n    this.brain.backward(reward);\r\n  }\r\n\r\n  get view(){\r\n    return this._view;\r\n  }\r\n  get position(){\r\n    return this._view.position;\r\n  }\r\n  set position(vec){\r\n    this._view.position.copy(vec);\r\n  }\r\n  get angle(){\r\n    return this._view.rotation.z;\r\n  }\r\n  set angle(val){\r\n    this._view.rotation.z = val;\r\n  }\r\n  get frontEye(){\r\n    return this._frontEye;\r\n  }\r\n}\r\n/**\r\n * @class Eye\r\n * It presents as agent's eye detector.\r\n */\r\nclass Eye{\r\n  /**\r\n   * \r\n   * @param {THREE.Vector3} agent_pos_vec Vector that would use as src\r\n   * vector for raycastring\r\n   * @param {Number} alpha angle \r\n   * @param {Number} r radius\r\n   */\r\n  constructor(a, alpha, r){\r\n    this._view = new THREE.Mesh(\r\n      new THREE.BoxBufferGeometry(1,1,10),\r\n      new THREE.MeshBasicMaterial({color: 0x111111})\r\n    );\r\n    /**setting Eye position and rotation */\r\n    this._view.position.x = Math.sin(Math.PI*alpha/180)*r;\r\n    this._view.position.y = Math.cos(Math.PI*alpha/180)*r;\r\n    this._view.rotation.z = Math.PI*(180-alpha)/180;\r\n    this._view.geometry.computeBoundingBox();\r\n    this.raycaster = new THREE.Raycaster();\r\n    this.max_range = 20;\r\n    this.sensed_proximity = 20; // what the eye is seeing. will be set in world.tick()\r\n    this.a = a;\r\n  }\r\n  get view(){\r\n    return this._view;\r\n  }\r\n  /**\r\n   * This function return the nearest detected object.\r\n   * @param {THREE.Mesh[]} targets array of intersection targets\r\n   * @returns {Object|null} \r\n   */\r\n  getNearestCollision(targets_objs){\r\n    let targets = targets_objs.map((el)=>{\r\n        return el.view;\r\n    });\r\n    let dst = new THREE.Vector3();\r\n    dst.setFromMatrixPosition( this._view.matrixWorld );\r\n    dst.add(this.a.position.clone().negate());\r\n    dst.normalize();\r\n    this.raycaster.set(this.a.position, dst);\r\n    let intersects = this.raycaster.intersectObjects(targets);\r\n    if (intersects.length > 0 && intersects[0].distance < this.max_range){\r\n      return {obj: intersects[0].object, type: intersects[0].object._rl.type, dist: intersects[0].distance}\r\n    } else {\r\n      return null;\r\n    }\r\n  }\r\n}\r\n  \r\n  class Wall {\r\n    constructor(p1, p2){\r\n      this._view = new THREE.Mesh(\r\n        new THREE.CubeBufferGeometry(),\r\n        new THREE.MeshBasicMaterial({color: 0xf2f2f2})\r\n      );\r\n      this.type = 0;\r\n    }\r\n    get boundingBox(){\r\n      this._view.geometry.computeBoundingBox();\r\n      return this._view.geometry.boundingBox;\r\n    }\r\n  }\r\n  \r\n  \r\n  var Item = THREE.Object3D;\r\n  /**\r\n   * @class\r\n   * World Contains all features.\r\n   */\r\n  class World  {\r\n    constructor(){\r\n      this.init();\r\n      this.agents = [];\r\n      // this.W = canvas.width;\r\n      // this.H = canvas.height;\r\n\r\n      this.W = 200;\r\n      this.H = 200;\r\n\r\n      this.clock = 0;\r\n      \r\n      // set up walls in the world\r\n      this.walls = []; \r\n      var pad = 10;\r\n      // util_add_box(this.walls, pad, pad, this.W-pad*2, this.H-pad*2);\r\n      // util_add_box(this.walls, 100, 100, 200, 300); // inner walls\r\n      // this.walls.pop();\r\n      // util_add_box(this.walls, 400, 100, 200, 300);\r\n      // this.walls.pop();\r\n      \r\n\r\n      // set up food and poison\r\n      this.items = []\r\n      for(var k=0;k<1000;k++) {\r\n        this.generateItem();\r\n      }\r\n      let agent = new Agent();\r\n      this.Scene.add(agent.view);\r\n      this.agents.push(agent);\r\n    }   \r\n\r\n    generateItem(){\r\n      var x = convnetjs.randf(20, this.W);\r\n      var y = convnetjs.randf(20, this.H);\r\n      var t = convnetjs.randi(1, 3); // food or poison (1 and 2)\r\n      if (t == 1){\r\n        var it = new Food(new THREE.Vector3(x, y, 0));\r\n      }\r\n      else{\r\n        var it = new Poison(new THREE.Vector3(x, y, 0));\r\n      }\r\n      this.items.push(it);\r\n      this.Scene.add(it.view);\r\n    }\r\n\r\n    init(json_params){\r\n      this.Container = document.createElement(\"div\");\r\n      this.Container.id = \"MainContainer\";\r\n      this.Container.classList.add(\"Container\");\r\n      \r\n      this.Renderer = new THREE.WebGLRenderer();\r\n      this.Renderer.setSize(window.innerWidth, window.innerHeight);\r\n      this.Container.appendChild(this.Renderer.domElement);\r\n\r\n      document.body.insertBefore( this.Container, document.body.firstChild);\r\n\r\n      this.stats = new Stats();\r\n      document.body.appendChild(this.stats.dom);\r\n\r\n      this.Camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 10000);\r\n      this.Camera.position.set(0,0, 10);\r\n      this.Scene = new THREE.Scene();\r\n      this.Scene.background = new THREE.Color( 0xaaccff );\r\n      this.Scene.fog = new THREE.FogExp2( 0xaaccff, 0.007 );\r\n      //        this.Scene.add(this.Camera);\r\n\r\n      this.Loader = new THREE.ColladaLoader();\r\n//        this.Loader.load(\"./src/scenes/telefermer.dae\", function (dae) {\r\n//            dae.scene.scale.set(10,10,10);\r\n//            this.Scene.add(dae.scene);\r\n//        }.bind(this));\r\n\r\n      this.AmbientLight = new THREE.AmbientLight(0xFFFFFF, 0.9);\r\n      this.Scene.add(this.AmbientLight);\r\n\r\n      // this.ControlObject = this.Object;\r\n      // // this.Camera.position.set(-1, 1.2, -0.35);\r\n      // this.Scene.add(this.ControlObject);\r\n      // this.ControlObject.add(this.Camera);\r\n      this.Controls = new THREE.FlyControls(this.Camera, document.getElementById(\"MainContainer\"));\r\n      this.Controls.movementSpeed = 13;\r\n      this.Controls.rollSpeed = Math.PI / 8;\r\n      this.Controls.autoForward = false;\r\n      this.Controls.dragToLook = false;\r\n      \r\n      this.Clock = new THREE.Clock();\r\n\r\n      let TextureLoader = new THREE.TextureLoader();\r\n      TextureLoader.load(\"./src/src/models/forest/grass.png\", function (tex) {\r\n          tex.wrapS = THREE.RepeatWrapping;\r\n          tex.wrapT = THREE.RepeatWrapping;\r\n          tex.repeat.set(100, 100);\r\n          let ground = new THREE.Mesh(new THREE.PlaneBufferGeometry(1000, 1000), new THREE.MeshBasicMaterial({map: tex, side:THREE.DoubleSide}));\r\n          //ground.rotation.x -= Math.PI/2;\r\n          this.Scene.add(ground);\r\n      }.bind(this));\r\n    }\r\n\r\n    render () {\r\n      //requestAnimationFrame(this.render);\r\n      this.stats.update();\r\n      // this.ControlObject.position.y = 0;\r\n      \r\n      this.Renderer.render(this.Scene, this.Camera);\r\n      var delta = this.Clock.getDelta();\r\n      // if(this.Controls.moveState.forward || this.Controls.moveState.back){\r\n      //     if (this.Mixer !== undefined ) {\r\n      //         this.Mixer.update(delta);\r\n      //     }\r\n      // }\r\n      // if (this.Mixer !== undefined ) {\r\n      //         this.Mixer.update(delta);\r\n      //     }\r\n      \r\n       w.agents[0].brain.visSelf(document.getElementById('brain_info_div'));\r\n      this.Controls.update(delta);\r\n  }\r\n\r\n    // helper function to get closest colliding walls/items\r\n    stuff_collide_(eye, check_walls, check_items) {\r\n      var minres = false;\r\n\r\n      if(check_walls) {\r\n          let res = eye.getNearestCollision(this.walls);\r\n          if(res) {\r\n            res.type = 0; // 0 is wall\r\n            if(!minres) { minres=res; }\r\n          }\r\n      }\r\n      // collide with items\r\n      if(check_items) {\r\n        let res = eye.getNearestCollision(this.items);\r\n        if(res) {\r\n          if(!minres) { minres=res; }\r\n        }\r\n      }\r\n      return minres;\r\n    }\r\n    removeItem(it){\r\n      this.Scene.remove(it.view);\r\n      this.items.splice(this.items.indexOf(it), 1);\r\n    }\r\n    tick() {\r\n      // tick the environment\r\n      this.clock++;\r\n      \r\n      // fix input to all agents based on environment\r\n      // process eyes\r\n      this.collpoints = [];\r\n      for(var i=0,n=this.agents.length;i<n;i++) {\r\n        var a = this.agents[i];\r\n        for(var ei=0,ne=a.eyes.length;ei<ne;ei++) {\r\n          var e = a.eyes[ei];\r\n          // we have a line from p to p->eyep\r\n          var res = this.stuff_collide_(e, true, true);\r\n          if(res) {\r\n            // eye collided with wall\r\n            e.sensed_proximity = res.dist;\r\n            e.sensed_type = res.type;\r\n          } else {\r\n            e.sensed_proximity = e.max_range;\r\n            e.sensed_type = -1;\r\n          }\r\n        }\r\n      }\r\n      \r\n      // let the agents behave in the world based on their input\r\n      for(var i=0,n=this.agents.length;i<n;i++) {\r\n        this.agents[i].forward();\r\n      }\r\n      \r\n      // apply outputs of agents on evironment\r\n      for(var i=0,n=this.agents.length;i<n;i++) {\r\n        var a = this.agents[i];\r\n        a.op = a.position.clone(); // back up old position\r\n        a.oangle = a.angle; // and angle\r\n        // steer the agent according to outputs of wheel velocities\r\n        var v = new THREE.Vector3(0, a.rad / 2.0);\r\n        var rotat = new THREE.Matrix4().makeRotationZ(a.angle + Math.PI/2);\r\n        v = v.applyMatrix4(rotat);\r\n        var w1p = a.position.clone().add(v); // positions of wheel 1 and 2\r\n        var w2p =a.position.clone().sub(v);\r\n        var vv = a.position.clone().sub(w2p);\r\n        rotat = new THREE.Matrix4().makeRotationZ(-a.rot1);\r\n        vv = vv.applyMatrix4(rotat);\r\n        var vv2 = a.position.clone().sub(w1p);\r\n        rotat = new THREE.Matrix4().makeRotationZ(a.rot2);\r\n        vv2 = vv2.clone().applyMatrix4(rotat);\r\n        var np = w2p.clone().add(vv);\r\n        np.multiplyScalar(0.5);\r\n        var np2 = w1p.clone().add(vv2);\r\n        np2.multiplyScalar(0.5);\r\n        a.position = np.add(np2);\r\n        \r\n        a.angle -= a.rot1;\r\n        if(a.angle<0)a.angle+=2*Math.PI;\r\n        a.angle += a.rot2;\r\n        if(a.angle>2*Math.PI)a.angle-=2*Math.PI;\r\n        \r\n        // agent is trying to move from p to op. Check walls\r\n        var res = this.stuff_collide_(a.frontEye, true, false);\r\n        if(res) {\r\n          // wall collision! reset position\r\n          a.position = a.op;\r\n        }\r\n        \r\n        // handle boundary conditions\r\n        if(a.position.x<0)a.position.x=0;\r\n        if(a.position.x>this.W)a.position.x=this.W;\r\n        if(a.position.y<0)a.position.y=0;\r\n        if(a.position.y>this.H)a.position.y=this.H;\r\n      }\r\n      \r\n      // tick all items\r\n      var update_items = false;\r\n      for(var i=0,n=this.items.length;i<n;i++) {\r\n        var it = this.items[i];\r\n        it.age += 1;\r\n        \r\n        // see if some agent gets lunch\r\n        for(var j=0,m=this.agents.length;j<m;j++) {\r\n          var a = this.agents[j];\r\n          var d = a.position.distanceTo(it.position);\r\n          if(d < it.rad + a.rad) {\r\n            \r\n            // wait lets just make sure that this isn't through a wall\r\n            var rescheck = this.stuff_collide_(a.frontEye, true, false);\r\n            if(!rescheck) { \r\n              // ding! nom nom nom\r\n              if(it.type === 1) a.digestion_signal += 5.0; // mmm delicious apple\r\n              if(it.type === 2) a.digestion_signal += -6.0; // ewww poison\r\n              this.removeItem(it);\r\n              i--;\r\n              n--;\r\n              break; // break out of loop, item was consumed\r\n            }\r\n          }\r\n        }\r\n        \r\n        if(it.age > 5000 && this.clock % 100 === 0 && convnetjs.randf(0,1)<0.1) {\r\n          this.removeItem(it);\r\n          i--;\r\n          n--;\r\n        }\r\n      }\r\n      if(this.items.length < 600 && this.clock % 10 === 0 && convnetjs.randf(0,1)<0.25) {\r\n        this.generateItem();\r\n      }\r\n      \r\n      // agents are given the opportunity to learn based on feedback of their action on environment\r\n      for(var i=0,n=this.agents.length;i<n;i++) {\r\n        this.agents[i].backward();\r\n      }\r\n    }\r\n  }\r\n  \r\n  \r\n  function draw_net() {\r\n    if(simspeed <=1) {\r\n      // we will always draw at these speeds\r\n    } else {\r\n      if(w.clock % 50 !== 0) return;  // do this sparingly\r\n    }\r\n    \r\n    var canvas = document.getElementById(\"net_canvas\");\r\n    var ctx = canvas.getContext(\"2d\");\r\n    var W = canvas.width;\r\n    var H = canvas.height;\r\n    ctx.clearRect(0, 0, canvas.width, canvas.height);\r\n    var L = w.agents[0].brain.value_net.layers;\r\n    var dx = (W - 50)/L.length;\r\n    var x = 10;\r\n    var y = 40;\r\n    ctx.font=\"12px Verdana\";\r\n    ctx.fillStyle = \"rgb(0,0,0)\";\r\n    ctx.fillText(\"Value Function Approximating Neural Network:\", 10, 14);\r\n    for(var k=0;k<L.length;k++) {\r\n      if(typeof(L[k].out_act)==='undefined') continue; // maybe not yet ready\r\n      var kw = L[k].out_act.w;\r\n      var n = kw.length;\r\n      var dy = (H-50)/n;\r\n      ctx.fillStyle = \"rgb(0,0,0)\";\r\n      ctx.fillText(L[k].layer_type + \"(\" + n + \")\", x, 35);\r\n      for(var q=0;q<n;q++) {\r\n        var v = Math.floor(kw[q]*100);\r\n        if(v >= 0) ctx.fillStyle = \"rgb(0,0,\" + v + \")\";\r\n        if(v < 0) ctx.fillStyle = \"rgb(\" + (-v) + \",0,0)\";\r\n        ctx.fillRect(x,y,10,10);\r\n        y += 12;\r\n        if(y>H-25) { y = 40; x += 12};\r\n      }\r\n      x += 50;\r\n      y = 40;\r\n    }\r\n  }\r\n  \r\n  var reward_graph = new cnnvis.Graph();\r\n  function draw_stats() {\r\n    var canvas = document.getElementById(\"vis_canvas\");\r\n    var ctx = canvas.getContext(\"2d\");\r\n    var W = canvas.width;\r\n    var H = canvas.height;\r\n    ctx.clearRect(0, 0, canvas.width, canvas.height);\r\n    var a = w.agents[0];\r\n    var b = a.brain;\r\n    var netin = b.last_input_array;\r\n    ctx.strokeStyle = \"rgb(0,0,0)\";\r\n    //ctx.font=\"12px Verdana\";\r\n    //ctx.fillText(\"Current state:\",10,10);\r\n    ctx.lineWidth = 10;\r\n    ctx.beginPath();\r\n    for(var k=0,n=netin.length;k<n;k++) {\r\n      ctx.moveTo(10+k*12, 120);\r\n      ctx.lineTo(10+k*12, 120 - netin[k] * 100);\r\n    }\r\n    ctx.stroke();\r\n    \r\n    if(w.clock % 200 === 0) {\r\n      reward_graph.add(w.clock/200, b.average_reward_window.get_average());\r\n      var gcanvas = document.getElementById(\"graph_canvas\");\r\n      reward_graph.drawSelf(gcanvas);\r\n    }\r\n  }\r\n\r\n  // Tick the world\r\n  function tick() {\r\n    w.tick();\r\n    if(!skipdraw || w.clock % 50 === 0) {\r\n      w.render();\r\n      draw_stats();\r\n      draw_net();\r\n    }\r\n  }\r\n  \r\n  var simspeed = 2;\r\n  function goveryfast() {\r\n    window.clearInterval(current_interval_id);\r\n    current_interval_id = setInterval(tick, 0);\r\n    skipdraw = true;\r\n    simspeed = 3;\r\n  }\r\n  function gofast() {\r\n    window.clearInterval(current_interval_id);\r\n    current_interval_id = setInterval(tick, 0);\r\n    skipdraw = false;\r\n    simspeed = 2;\r\n  }\r\n  function gonormal() {\r\n    window.clearInterval(current_interval_id);\r\n    current_interval_id = setInterval(tick, 30);\r\n    skipdraw = false;\r\n    simspeed = 1;\r\n  }\r\n  function goslow() {\r\n    window.clearInterval(current_interval_id);\r\n    current_interval_id = setInterval(tick, 200);\r\n    skipdraw = false;\r\n    simspeed = 0;\r\n  }\r\n  \r\n  function savenet() {\r\n    var j = w.agents[0].brain.value_net.toJSON();\r\n    var t = JSON.stringify(j);\r\n    document.getElementById('tt').value = t;\r\n  }\r\n  \r\n  function loadnet() {\r\n    var t = document.getElementById('tt').value;\r\n    var j = JSON.parse(t);\r\n    w.agents[0].brain.value_net.fromJSON(j);\r\n    stoplearn(); // also stop learning\r\n    gonormal();\r\n  }\r\n  \r\n  function startlearn() {\r\n    w.agents[0].brain.learning = true;\r\n  }\r\n  function stoplearn() {\r\n    w.agents[0].brain.learning = false;\r\n  }\r\n  \r\n  function reload() {\r\n    w.agents = [new Agent()]; // this should simply work. I think... ;\\\r\n    reward_graph = new cnnvis.Graph(); // reinit\r\n  }\r\n  \r\n  var w; // global world object\r\n  var current_interval_id;\r\n  var skipdraw = false;\r\n\r\n  function start() {\r\n    canvas = document.getElementById(\"canvas\");\r\n    ctx = canvas.getContext(\"2d\");\r\n    \r\n    w = new World();\r\n    \r\n    gofast();\r\n  }"]}